rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FONCTIONS HELPER
    // ============================================
    
    // Vérifier si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Vérifier si l'utilisateur est le propriétaire
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Vérifier si l'utilisateur est membre d'un workspace
    function isWorkspaceMember(workspaceId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/workspaceMembers/$(workspaceId + '_' + request.auth.uid));
    }
    
    // Vérifier si l'utilisateur est admin d'un workspace
    function isWorkspaceAdmin(workspaceId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/workspaceMembers/$(workspaceId + '_' + request.auth.uid)) &&
             get(/databases/$(database)/documents/workspaceMembers/$(workspaceId + '_' + request.auth.uid)).data.role == 'admin';
    }
    
    
    // ============================================
    // COLLECTION USERS
    // ============================================
    
    match /users/{userId} {
      // Lecture : l'utilisateur peut lire son propre document
      allow read: if isOwner(userId);
      
      // Création : uniquement lors de la première connexion
      allow create: if isAuthenticated() && 
                       request.auth.uid == userId &&
                       request.resource.data.uid == userId &&
                       request.resource.data.email == request.auth.token.email;
      
      // Mise à jour : l'utilisateur peut modifier son propre document
      // mais ne peut pas modifier certains champs sensibles
      allow update: if isOwner(userId) &&
                       request.resource.data.uid == resource.data.uid &&
                       request.resource.data.email == resource.data.email &&
                       request.resource.data.createdAt == resource.data.createdAt;
      
      // Suppression : interdite (soft delete recommandé via un champ 'deleted')
      allow delete: if false;
      
      // Sous-collection userProfile pour les informations détaillées du profil
      match /profile/{profileId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId) && request.resource.data.userId == userId;
        allow delete: if false;
      }
    }
    
    // ============================================
    // COLLECTION WORKSPACES
    // ============================================
    
    match /workspaces/{workspaceId} {
      // Lecture : les membres du workspace peuvent lire
      allow read: if isWorkspaceMember(workspaceId);
      
      // Création : utilisateurs authentifiés peuvent créer un workspace
      // Le créateur doit s'ajouter comme admin dans workspaceMembers immédiatement après
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['name', 'ownerId', 'createdAt']);
      
      // Mise à jour : seuls les admins peuvent modifier
      allow update: if isWorkspaceAdmin(workspaceId) &&
                       request.resource.data.ownerId == resource.data.ownerId &&
                       request.resource.data.createdAt == resource.data.createdAt;
      
      // Suppression : seuls les admins peuvent supprimer
      // Note: La vérification du nombre de membres doit être faite côté application
      allow delete: if isWorkspaceAdmin(workspaceId);
    }
    
    // ============================================
    // COLLECTION WORKSPACE MEMBERS
    // ============================================
    
    match /workspaceMembers/{memberId} {
      // Format du memberId: {workspaceId}_{userId}
      
      // Lecture : 
      // - L'utilisateur peut lire ses propres appartenances (nécessaire pour la query getUserWorkspaces)
      // - OU les membres du même workspace peuvent voir les autres membres
      allow read: if isAuthenticated() && 
                     (
                       resource.data.userId == request.auth.uid ||
                       isWorkspaceMember(resource.data.workspaceId)
                     );
      
      // Création : 
      // - Admin du workspace peut ajouter des membres
      // - OU l'utilisateur lui-même lors de l'acceptation d'une invitation
      allow create: if isAuthenticated() &&
                       request.resource.data.workspaceId != null &&
                       request.resource.data.userId != null &&
                       memberId == request.resource.data.workspaceId + '_' + request.resource.data.userId &&
                       (
                         // Admin ajoute un membre
                         (isWorkspaceAdmin(request.resource.data.workspaceId)) ||
                         // Utilisateur s'ajoute lui-même via invitation (vérifié côté app)
                         (request.resource.data.userId == request.auth.uid)
                       );
      
      // Mise à jour : seuls les admins peuvent modifier (changer de rôle)
      allow update: if isAuthenticated() &&
                       isWorkspaceAdmin(resource.data.workspaceId) &&
                       request.resource.data.workspaceId == resource.data.workspaceId &&
                       request.resource.data.userId == resource.data.userId;
      
      // Suppression : 
      // - Admin peut retirer des membres
      // - OU l'utilisateur peut se retirer lui-même
      // Note: La vérification du dernier admin doit être faite côté application
      allow delete: if isAuthenticated() &&
                       (
                         isWorkspaceAdmin(resource.data.workspaceId) ||
                         resource.data.userId == request.auth.uid
                       );
    }
    
    // ============================================
    // COLLECTION WORKSPACE INVITATIONS
    // ============================================
    
    match /workspaceInvitations/{invitationId} {
      // Lecture : 
      // - Admins du workspace
      // - OU l'email de l'invitation correspond à l'email de l'utilisateur
      allow read: if isAuthenticated() && 
                     (
                       isWorkspaceAdmin(resource.data.workspaceId) ||
                       resource.data.email == request.auth.token.email
                     );
      
      // Création : seuls les admins du workspace peuvent inviter
      allow create: if isAuthenticated() &&
                       request.resource.data.workspaceId != null &&
                       isWorkspaceAdmin(request.resource.data.workspaceId) &&
                       request.resource.data.invitedBy == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.email is string &&
                       request.resource.data.role in ['admin', 'member'];
      
      // Mise à jour : 
      // - Le destinataire peut accepter/refuser (changer status)
      // - OU les admins peuvent annuler
      allow update: if isAuthenticated() &&
                       (
                         // Destinataire accepte/refuse
                         (resource.data.email == request.auth.token.email &&
                          request.resource.data.status in ['accepted', 'declined'] &&
                          resource.data.status == 'pending') ||
                         // Admin annule
                         (isWorkspaceAdmin(resource.data.workspaceId) &&
                          request.resource.data.status == 'cancelled')
                       );
      
      // Suppression : seuls les admins peuvent supprimer
      allow delete: if isAuthenticated() && 
                       isWorkspaceAdmin(resource.data.workspaceId);
    }
    
    // ============================================
    // COLLECTION SUBSCRIPTIONS (legacy - workspaces)
    // ============================================
    
    match /subscriptions/{subscriptionId} {
      // Lecture : les admins du workspace peuvent lire
      allow read: if isAuthenticated() && 
                     resource.data.workspaceId != null &&
                     isWorkspaceAdmin(resource.data.workspaceId);
      
      // Création/modification : uniquement par les webhooks Stripe (backend)
      // ou Cloud Functions authentifiées
      allow create, update: if false; // Sera géré par Cloud Functions
      
      // Suppression : interdite
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION USER SUBSCRIPTIONS (nouveau - utilisateurs)
    // ============================================
    
    match /userSubscriptions/{subscriptionId} {
      // Lecture : l'utilisateur peut lire son propre abonnement
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Création : l'utilisateur peut créer son propre abonnement (pour synchronisation depuis Stripe)
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'stripeCustomerId', 'stripeSubscriptionId', 'planType', 'planName', 'status', 'searchesPerMonth', 'amount', 'currency', 'isRecurring']);
      
      // Mise à jour : l'utilisateur peut mettre à jour son propre abonnement (pour synchronisation)
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId;
      
      // Suppression : interdite
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION SPONSOR SEARCH USAGE
    // ============================================
    
    match /sponsorSearchUsage/{usageId} {
      // Lecture : l'utilisateur peut lire son propre historique
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Création : l'utilisateur peut enregistrer son propre usage
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'workspaceId', 'subscriptionId', 'searchId', 'eventName', 'recommendationsCount', 'usedAt', 'billingMonth']);
      
      // Mise à jour : interdite
      allow update: if false;
      
      // Suppression : interdite
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION USER DATA
    // ============================================
    
    match /userData/{dataId} {
      // Lecture : les membres du workspace peuvent lire
      allow read: if isAuthenticated() && 
                     resource.data.workspaceId != null &&
                     isWorkspaceMember(resource.data.workspaceId);
      
      // Création : les membres du workspace peuvent créer des données
      allow create: if isAuthenticated() && 
                       request.resource.data.workspaceId != null &&
                       isWorkspaceMember(request.resource.data.workspaceId) &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Mise à jour : les membres du workspace peuvent modifier
      allow update: if isAuthenticated() && 
                       resource.data.workspaceId != null &&
                       isWorkspaceMember(resource.data.workspaceId) &&
                       request.resource.data.workspaceId == resource.data.workspaceId;
      
      // Suppression : 
      // - Admins du workspace
      // - OU le créateur de la donnée
      allow delete: if isAuthenticated() && 
                       resource.data.workspaceId != null &&
                       (
                         isWorkspaceAdmin(resource.data.workspaceId) ||
                         resource.data.createdBy == request.auth.uid
                       );
    }
    
    // ============================================
    // COLLECTION AUDIT LOGS
    // ============================================
    
    match /auditLogs/{logId} {
      // Lecture : l'utilisateur peut lire ses propres logs
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Création/modification : uniquement par Cloud Functions
      allow create, update, delete: if false;
    }
    
    // ============================================
    // COLLECTION USER SESSIONS
    // ============================================
    
    match /userSessions/{sessionId} {
      // Lecture : l'utilisateur peut lire ses propres sessions
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Création/modification : géré par l'application
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid;
      
      // Suppression : interdite
      allow delete: if false;
    }
    
    // ============================================
    // COLLECTION APP SETTINGS
    // ============================================
    
    match /appSettings/{settingId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isAuthenticated();
      
      // Création/modification : uniquement par les admins (géré par Cloud Functions)
      allow create, update, delete: if false;
    }
    
    // ============================================
    // COLLECTION SPONSOR SEARCHES
    // ============================================
    
    match /sponsorSearches/{searchId} {
      // Lecture : les membres du workspace peuvent lire leurs recherches
      allow read: if isAuthenticated() && 
                     resource.data.workspaceId != null &&
                     isWorkspaceMember(resource.data.workspaceId);
      
      // Création : les membres du workspace peuvent créer des recherches
      allow create: if isAuthenticated() && 
                       request.resource.data.workspaceId != null &&
                       isWorkspaceMember(request.resource.data.workspaceId) &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Mise à jour : les membres du workspace peuvent modifier
      // (pour mettre à jour les statuts de contact, notes, etc.)
      allow update: if isAuthenticated() && 
                       resource.data.workspaceId != null &&
                       isWorkspaceMember(resource.data.workspaceId);
      
      // Suppression : 
      // - Admins du workspace
      // - OU le créateur de la recherche
      allow delete: if isAuthenticated() && 
                       resource.data.workspaceId != null &&
                       (
                         isWorkspaceAdmin(resource.data.workspaceId) ||
                         resource.data.createdBy == request.auth.uid
                       );
    }
    
    // ============================================
    // RÈGLE PAR DÉFAUT
    // ============================================
    
    // Règle par défaut : interdire tout accès
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
